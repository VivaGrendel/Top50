<html>
<head>
	<link rel="stylesheet" type="text/css" href="top50.css" />

	<style>
div {
	display: block;
}

.spotifyPl {
	right: 0px;
	bottom: 0px;
	cursor: pointer;
}

.spotifyPl:hover {
	text-decoration: underline;
}

.dragContainer, .drag {
	cursor: pointer;
	width: 250px;
	height: 80px;
	overflow: hidden;
}

.dragContainer {
	position: fixed;
	display: none;
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	border-radius: 10px;	
	top: 50%;
	left: 50%;
	margin-left: -125px;
	margin-top: -40px;
    outline: 0 none;
    background-color: red;
    border: 2px dotted black;
	overflow: hidden;
}

.drag{
	position: absolute;
	z-index: 100000;
	opacity: 0;
	overflow: hidden;
}

.dragContainer > div#text {
	position: absolute;
	text-align: center;
}
	</style>

	<script type="text/javascript" src="jquery-1.7.1.js"></script>

	<script type="text/javascript">
	$(document).ready(function(){
		Top50.getChartForMonth("2009", 7);
/*
		Top50.getChartForMonth("1980", "9");
		Top50.getChartForMonth("1980", "September");
		Top50.getChartForMonth("1980", "sep");
		Top50.getChartForMonth("1980", "");
		Top50.getChartForMonth("1980", 14);
		Top50.getChartForMonth("1980", "14");
		Top50.getChartForMonth("2050", 9);
		Top50.getChartForMonth("YEAR", 9);
*/
	});

	Top50 = function(jQuery) {
		// BILLBOARD API
		var BILLBOARD_API_KEY	= "y4jsbc3q29xrrmdpf4am84sx";
		var BILLBOARD_CHART_ID	= "379";
		var CHARTS_URL			= "http://api.billboard.com/apisvc/chart/v1/list?id=%CHART_ID%&sdate=%YEAR%-%MONTH%-01&edate=%YEAR%-%MONTH%-30&api_key=%API_KEY%&format=json";
		var CHART_RECORDS_COUNT	= 50;
		var MAX_CHART_NUM		= 50;

		// LAST.FM API
		var LAST_FM_API_KEY		= "8205c5b91c533ae09c682523971a569d";
		var LAST_FM_TRACK_INFO	= "http://ws.audioscrobbler.com/2.0/?method=track.getinfo&api_key=" + LAST_FM_API_KEY + "&artist=%ARTIST%&track=%TRACK%&format=json";

		// SPOTIFY METADATA API
		var SPOTIFY_SEARCH		= "http://ws.spotify.com/search/1/track.json?q=track:%TRACK%%20%artist:%ARTIST%%20year:%YEAR%";

		var $ = jQuery,
			log = function(txt) { console.debug(txt) },
			monthS = ["jan","feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"],
			date = new Date(),
			playlist = [], currentYear = 0;

		function getChartForMonth(year, month) {
			month = formatMonth(month);
			year = formatYear(year);
			currentYear = year;
			
			if (!month || !year) {
				log("Unable to get the Charts for " + month + " and " + year);
				return;
			}
			console.debug("Getting Charts for " + [month, year].join("."));
			
			getChart(function(chartItems) {
					//var resCount = chartItems.length;
					var resCount = 5;

					chartItems = chartItems.sort(function(a, b) {           
						return a.rank - b.rank;
					});

					if (resCount > 0) {
						for (var i=0; i<MAX_CHART_NUM; i++) {
							var item = chartItems[i];
							//log(item);
							playlist.push(item);
							//log(item.rank + "\t- " + item.song + " (" + item.artist + ")");
							
							var li = top50LiTemplate.replace("%RANK%", i+1)
										.replace("%COVER_IDX%", i)
										.replace("%TRACK%", item.song)
										.replace("%ARTIST%", item.artist);

							$(li).appendTo($("#top50List"));

							getAlbumArt(i, item.artist, item.song);
						}
						
						$('<div class="spotifyPl">Get Spotify Playlist</div>')
							.click(getSpotifyPlaylist)
							.appendTo('body')
					}
				}, 
				year, 
				month
			);
		}

		var top50LiTemplate = '<li><img id="cover%COVER_IDX%" src="assets/defaultCover.jpg" class="albumCover" />' 
			+ '<div class="rank">%RANK%</div>' 
			+ '<div class="track">%TRACK%</div>' 
			+ '<div class="artist">%ARTIST%</div>'
			+ '</li>';

		function getAlbumArt(coverIdx, artist, track) {
			var url = LAST_FM_TRACK_INFO.replace("%ARTIST%", artist)
				.replace("%TRACK%", track);

			$.ajax({
				url: url,
				dataType:"jsonp",
				success: function(data) {
					if (data.track.album) {
						//log(">>> " + data.track.album.image[0]["#text"]);
						$("#cover" + coverIdx).attr("src", data.track.album.image[0]["#text"])
					}
				}
			});
		}

		function getSpotifyPlaylist() {
			var l = playlist.length;
			var foundSpotifyUriIdx = 0;
			var foundSpotifyUri = [];

			if (l > 0) {
				for (var i=0; i<l; i++) {
					var item = playlist[i];
					getSpotifyURI(i, item.song, item.artist, currentYear, function(idx, data) {
						log(data);
						foundSpotifyUriIdx++;
						if (data.info.num_results > 0) {
							foundSpotifyUri.push({idx:idx, href:data.tracks[0].href});
						}
						if (foundSpotifyUriIdx == l) {
							foundSpotifyUri = foundSpotifyUri.sort(function(a, b) {           
								return a.idx - b.idx;
							});

							var res = "";
							for (var j=0; j<foundSpotifyUri.length; j++) {
								res += foundSpotifyUri[j].href + " ";
							}
							log(res);
							$(".drag").html('"' + res + '"');
							$(".dragContainer").show("fast");
							$(".dragContainer > div#text").html("Found " + foundSpotifyUri.length + " of the playlist tracks in Spotify.<br />Drag and drop this box in Spotify!")
						}
					});
				}
			}
		}

		function getSpotifyURI(i, track, artist, year, callBack) {
			var url = SPOTIFY_SEARCH.replace("%TRACK%", encodeURIComponent(track))
				.replace("%ARTIST%", encodeURIComponent(artist))
				.replace("%YEAR%", (year-5)+"-"+year);

			log(url);
			$.ajax({
				url: url,
				dataType:"json",
				success: function(data) {
					callBack(i, data);
				}
			});
		}

		function getChart(successFunc, year, month, chartItems, startPos) {
			if (!chartItems) { chartItems = []; }
			if (!startPos) { startPos = 1; }

			var url = CHARTS_URL.replace("%API_KEY%", BILLBOARD_API_KEY)
				.replace("%CHART_ID%", BILLBOARD_CHART_ID)
				.replace(/%YEAR%/g, year)
				.replace(/%MONTH%/g, month);
				
			if (startPos) {
				url += "&start=" + startPos;
			}

			$.ajax({
				url: url,
				dataType:"jsonp",
				success: function(data) {
					chartItems = chartItems.concat(data.searchResults.chartItem);
					
					if (chartItems.length < data.searchResults.totalRecords) {
						startPos += CHART_RECORDS_COUNT;
						getChart(successFunc, year, month, chartItems, startPos);
					} else {
						successFunc(chartItems);
					}
				}
			});
		}

		function formatMonth(month) {
			var t = !isNaN(parseInt(month)) ? "number" : typeof(month);

			if (t == "number") {
				return (month < 10) ? "0" + month : (month < 12) ? month : null;
			}
			else if (t == "string") {
				var i = $.inArray(month.substr(0, 3).toLowerCase(), monthS);
				if (i > -1) {
					i++;
					return (i < 10) ? "0" + i : (i < 12) ? i : null;
				}
			}
			return null;
		}

		function formatYear(year) {
			year = parseInt(year);
			return !isNaN(year) ? (year <= date.getFullYear()) ? year : null : null;
		}

		return {
			getChartForMonth: getChartForMonth
		};
	}(jQuery);

	function selectText()
	{
		if (document.selection)
		{
			var div = document.body.createTextRange();

			div.moveToElementText(document.getElementById("drag"));
			div.select();
		}
		else
		{
			var div = document.createRange();

			div.setStartBefore(document.getElementById("drag"));
			div.setEndAfter(document.getElementById("drag")) ;

			window.getSelection().addRange(div);
		}
	}
	</script>
</head>
<body>
	<ul id="top50List">
		
	</ul>
	
	<div class="dragContainer"><div id="text"></div><div id="drag" onmouseover="selectText();" class="drag"></div></div>
</body>
</html>